<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Binary Arithmetic — Decimal↔Binary, Addition &amp; Subtraction</title>
<style>
  *{margin:0;padding:0;box-sizing:border-box}
  body{background:#0d1117;color:#e6edf3;font-family:'Segoe UI',system-ui,sans-serif;
    display:flex;flex-direction:column;align-items:center;min-height:100vh;padding:18px}
  h1{font-size:1.5em;color:#e0e0ff}
  .subtitle{color:#7d8590;margin-bottom:10px;font-size:.92em;text-align:center;max-width:820px}

  .tabs{display:flex;gap:6px;margin:10px 0;flex-wrap:wrap;justify-content:center}
  .tab{padding:8px 18px;border-radius:8px;cursor:pointer;font-size:.86em;
    background:#161b22;border:1px solid #30363d;color:#8b949e;transition:.2s}
  .tab:hover{border-color:#58a6ff;color:#e6edf3}
  .tab.active{background:#1f6feb;border-color:#1f6feb;color:white;font-weight:bold}

  .main{max-width:900px;width:100%;margin-top:10px}
  .panel{background:#161b22;border-radius:12px;padding:18px;border:1px solid #30363d;margin-bottom:12px}
  .panel h2{font-size:.95em;color:#8b949e;margin-bottom:10px;text-align:center}

  /* Input row */
  .input-row{display:flex;gap:10px;align-items:center;justify-content:center;flex-wrap:wrap;margin-bottom:12px}
  .input-row label{font-size:.85em;color:#8b949e}
  input[type="number"],input[type="text"]{background:#0d1117;border:1px solid #30363d;border-radius:6px;
    color:#e6edf3;padding:8px 12px;font-size:1em;font-family:'Courier New',monospace;width:160px;text-align:center}
  input[type="number"]:focus,input[type="text"]:focus{border-color:#58a6ff;outline:none}
  button{background:#238636;color:white;border:none;padding:8px 16px;border-radius:6px;
    cursor:pointer;font-size:.85em;transition:.2s}
  button:hover{background:#2ea043}
  button.sec{background:#30363d}
  button.sec:hover{background:#484f58}
  select{background:#0d1117;border:1px solid #30363d;border-radius:6px;color:#e6edf3;
    padding:6px 10px;font-size:.85em}

  /* Bit display */
  .bits-row{display:flex;gap:4px;justify-content:center;align-items:flex-end;margin:10px 0;flex-wrap:wrap}
  .bit-col{display:flex;flex-direction:column;align-items:center;gap:2px}
  .bit-weight{font-size:.65em;color:#484f58}
  .bit-power{font-size:.7em;color:#7d8590}
  .bit-cell{width:42px;height:42px;display:flex;align-items:center;justify-content:center;
    border-radius:8px;font-size:1.3em;font-weight:bold;font-family:'Courier New',monospace;
    cursor:pointer;transition:all .15s;user-select:none}
  .bit-cell.b0{background:#21262d;color:#484f58;border:2px solid #30363d}
  .bit-cell.b1{background:#1f6feb;color:white;border:2px solid #58a6ff;box-shadow:0 0 8px #1f6feb40}
  .bit-cell:hover{transform:scale(1.08)}
  .bit-cell.carry{background:#d2992220;color:#d29922;border:2px solid #d29922}
  .bit-cell.borrow{background:#da363320;color:#da3633;border:2px solid #da3633}

  /* Step display */
  .steps{margin-top:12px}
  .step-row{display:flex;gap:2px;justify-content:center;margin:2px 0;align-items:center}
  .step-cell{width:42px;height:36px;display:flex;align-items:center;justify-content:center;
    font-size:1.1em;font-weight:bold;font-family:'Courier New',monospace;border-radius:4px}
  .step-label{width:60px;text-align:right;font-size:.8em;color:#8b949e;padding-right:8px}
  .step-sep{height:2px;background:#30363d;margin:4px 0}
  .carry-row .step-cell{font-size:.85em;color:#d29922;height:24px}
  .borrow-row .step-cell{font-size:.85em;color:#da3633;height:24px}
  .result-row .step-cell{color:#3fb950;font-size:1.2em}
  .highlight{animation:pulse .5s ease}
  @keyframes pulse{0%{transform:scale(1)}50%{transform:scale(1.15)}100%{transform:scale(1)}}

  /* Division steps for conversion */
  .div-steps{font-family:'Courier New',monospace;font-size:.9em;line-height:1.8;
    color:#8b949e;margin:10px 0;text-align:center}
  .div-steps .quo{color:#58a6ff}
  .div-steps .rem{color:#3fb950;font-weight:bold}
  .div-steps .arrow{color:#484f58}

  /* Result display */
  .result-box{background:#0d1117;border:1px solid #30363d;border-radius:10px;
    padding:12px;text-align:center;margin:10px 0}
  .result-val{font-size:1.4em;font-family:'Courier New',monospace;font-weight:bold}
  .result-label{font-size:.78em;color:#8b949e;margin-bottom:4px}

  .controls-row{display:flex;gap:8px;justify-content:center;flex-wrap:wrap;margin:8px 0}

  .info{max-width:900px;width:100%;background:#161b22;border-radius:12px;
    padding:14px 18px;border:1px solid #30363d;margin-top:14px;font-size:.84em;line-height:1.6;color:#8b949e}
  .info strong{color:#e0e0ff}
  .info code{color:#f78166;background:#21262d;padding:1px 4px;border-radius:3px}
  a{color:#58a6ff}

  .op-symbol{font-size:1.3em;font-weight:bold;color:#bc8cff;width:42px;text-align:center}
  .eq-symbol{font-size:1.1em;color:#8b949e;margin:0 6px}
  .dec-val{font-family:'Courier New',monospace;font-size:1.1em;color:#f78166}
  .hidden{display:none}
</style>
</head>
<body>

<h1>Binary Arithmetic</h1>
<p class="subtitle">Decimal ↔ Binary conversion step-by-step, plus binary addition and subtraction with carry/borrow visualization</p>

<div class="tabs">
  <div class="tab active" data-tab="dec2bin">Decimal → Binary</div>
  <div class="tab" data-tab="bin2dec">Binary → Decimal</div>
  <div class="tab" data-tab="add">Binary Addition</div>
  <div class="tab" data-tab="sub">Binary Subtraction</div>
</div>

<div class="main">

<!-- ═══════════ Tab 1: Decimal → Binary ═══════════ -->
<div id="tab-dec2bin" class="tab-content">
  <div class="panel">
    <h2>Decimal → Binary Conversion (Divide by 2)</h2>
    <div class="input-row">
      <label>Decimal:</label>
      <input type="number" id="d2b-input" min="0" max="255" value="42">
      <button id="d2b-go">Convert</button>
      <button id="d2b-step" class="sec">Step-by-Step</button>
      <button id="d2b-random" class="sec">Random</button>
    </div>
    <div class="result-box">
      <div class="result-label">Binary Result</div>
      <div class="result-val" id="d2b-result" style="color:#3fb950">—</div>
    </div>
    <div class="div-steps" id="d2b-steps"></div>
    <div class="bits-row" id="d2b-bits"></div>
  </div>
</div>

<!-- ═══════════ Tab 2: Binary → Decimal ═══════════ -->
<div id="tab-bin2dec" class="tab-content hidden">
  <div class="panel">
    <h2>Binary → Decimal Conversion (Positional Weights)</h2>
    <div class="input-row">
      <label>Binary:</label>
      <input type="text" id="b2d-input" value="101010" maxlength="8" pattern="[01]*">
      <button id="b2d-go">Convert</button>
      <button id="b2d-random" class="sec">Random</button>
    </div>
    <div class="result-box">
      <div class="result-label">Decimal Result</div>
      <div class="result-val" id="b2d-result" style="color:#f78166">—</div>
    </div>
    <div id="b2d-bits-area"></div>
    <div class="div-steps" id="b2d-steps"></div>
  </div>
</div>

<!-- ═══════════ Tab 3: Binary Addition ═══════════ -->
<div id="tab-add" class="tab-content hidden">
  <div class="panel">
    <h2>Binary Addition (with Carry)</h2>
    <div class="input-row">
      <label>A (dec):</label>
      <input type="number" id="add-a" min="0" max="127" value="25">
      <label>B (dec):</label>
      <input type="number" id="add-b" min="0" max="127" value="19">
      <button id="add-go">Add</button>
      <button id="add-step" class="sec">Step-by-Step</button>
      <button id="add-random" class="sec">Random</button>
    </div>
    <div class="result-box" id="add-result-box">
      <div class="result-label">A + B</div>
      <div class="result-val" id="add-result" style="color:#3fb950">—</div>
    </div>
    <div class="steps" id="add-steps"></div>
  </div>
</div>

<!-- ═══════════ Tab 4: Binary Subtraction ═══════════ -->
<div id="tab-sub" class="tab-content hidden">
  <div class="panel">
    <h2>Binary Subtraction (with Borrow)</h2>
    <div class="input-row">
      <label>A (dec):</label>
      <input type="number" id="sub-a" min="0" max="255" value="44">
      <label>B (dec):</label>
      <input type="number" id="sub-b" min="0" max="255" value="19">
      <button id="sub-go">Subtract</button>
      <button id="sub-step" class="sec">Step-by-Step</button>
      <button id="sub-random" class="sec">Random</button>
    </div>
    <div class="input-row">
      <label style="font-size:.78em">Method:</label>
      <select id="sub-method">
        <option value="borrow">Direct Borrow</option>
        <option value="ones">One's Complement</option>
        <option value="twos">Two's Complement</option>
      </select>
    </div>
    <div class="result-box" id="sub-result-box">
      <div class="result-label">A − B</div>
      <div class="result-val" id="sub-result" style="color:#3fb950">—</div>
    </div>
    <div class="steps" id="sub-steps"></div>
  </div>
</div>

</div><!-- /main -->

<div class="info">
  <strong>Decimal → Binary:</strong> Repeatedly divide by 2. The remainders (read bottom→top) form the binary number.
  <code>42 ÷ 2 = 21 r0, 21 ÷ 2 = 10 r1, ... → 101010</code>
  <br><br>
  <strong>Binary → Decimal:</strong> Multiply each bit by its positional weight (2<sup>n</sup>) and sum.
  <code>101010 = 1×32 + 0×16 + 1×8 + 0×4 + 1×2 + 0×1 = 42</code>
  <br><br>
  <strong>Binary Addition:</strong> 0+0=0, 0+1=1, 1+0=1, 1+1=10 (write 0, carry 1). Just like decimal addition but base-2.
  <br><br>
  <strong>Binary Subtraction:</strong> Three methods —
  <em>Direct Borrow</em> (like decimal: borrow from the next column when needed),
  <em>One's Complement</em> (invert B, add to A, then end-around carry — add any overflow carry back to the LSB), or
  <em>Two's Complement</em> (invert B, add 1, then add to A — the standard hardware method).
  <br><br>
  <a href="index.html">← 3-Phase AC</a> ·
  <a href="kmap.html">K-Map Simplifier</a> ·
  <a href="bounce-diagram.html">Bounce Diagram</a> ·
  <a href="transformer.html">Transformer</a> ·
  <a href="maxwell.html">Maxwell's Equations</a> ·
  <a href="poynting.html">Poynting Theorem</a> ·
  <a href="vectors.html">Dot &amp; Cross Product</a> ·
  <a href="phasor-transform.html">Phasor Transform</a> ·
  <a href="sawtooth-transmission.html">Sawtooth Transmission</a>
</div>

<script>
// ── Tab switching ──
const tabs = document.querySelectorAll('.tab');
tabs.forEach(t => t.addEventListener('click', () => {
  tabs.forEach(x => x.classList.remove('active'));
  t.classList.add('active');
  document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
  document.getElementById('tab-' + t.dataset.tab).classList.remove('hidden');
}));

// ── Helpers ──
function toBin(n, bits) {
  if (bits === undefined) bits = Math.max(1, Math.ceil(Math.log2((n || 1) + 1)));
  return n.toString(2).padStart(bits, '0');
}

function makeBitsRow(container, binStr, opts = {}) {
  container.innerHTML = '';
  const bits = binStr.split('');
  const len = bits.length;
  for (let i = 0; i < len; i++) {
    const col = document.createElement('div');
    col.className = 'bit-col';
    const power = len - 1 - i;
    const weight = 1 << power;
    const pw = document.createElement('div');
    pw.className = 'bit-power';
    pw.textContent = '2' + superscript(power);
    col.appendChild(pw);
    const wt = document.createElement('div');
    wt.className = 'bit-weight';
    wt.textContent = weight;
    col.appendChild(wt);
    const cell = document.createElement('div');
    cell.className = 'bit-cell ' + (bits[i] === '1' ? 'b1' : 'b0');
    cell.textContent = bits[i];
    if (opts.clickable) {
      cell.style.cursor = 'pointer';
      cell.dataset.idx = i;
      cell.addEventListener('click', () => {
        bits[i] = bits[i] === '1' ? '0' : '1';
        if (opts.onToggle) opts.onToggle(bits.join(''));
      });
    }
    col.appendChild(cell);
    container.appendChild(col);
  }
}

function superscript(n) {
  const sup = '⁰¹²³⁴⁵⁶⁷⁸⁹';
  return String(n).split('').map(c => sup[+c]).join('');
}

// ══════════════════════════════════════
//  TAB 1: Decimal → Binary
// ══════════════════════════════════════
let d2bStepTimer = null;

function d2bConvert(stepping) {
  if (d2bStepTimer) { clearInterval(d2bStepTimer); d2bStepTimer = null; }
  let dec = Math.max(0, Math.min(255, Math.floor(+document.getElementById('d2b-input').value) || 0));
  document.getElementById('d2b-input').value = dec;

  if (dec === 0) {
    document.getElementById('d2b-result').textContent = '0';
    document.getElementById('d2b-steps').innerHTML = '<span class="quo">0</span> ÷ 2 = <span class="quo">0</span> remainder <span class="rem">0</span>';
    makeBitsRow(document.getElementById('d2b-bits'), '0');
    return;
  }

  // Compute all division steps
  const steps = [];
  let val = dec;
  while (val > 0) {
    const q = Math.floor(val / 2);
    const r = val % 2;
    steps.push({ val, q, r });
    val = q;
  }
  const binStr = steps.map(s => s.r).reverse().join('');

  if (!stepping) {
    // Show all at once
    showD2BSteps(steps, steps.length);
    document.getElementById('d2b-result').textContent = binStr + '  (' + dec + '₁₀)';
    makeBitsRow(document.getElementById('d2b-bits'), binStr);
  } else {
    // Animate step by step
    document.getElementById('d2b-result').textContent = '...';
    document.getElementById('d2b-bits').innerHTML = '';
    let step = 0;
    showD2BSteps(steps, 0);
    d2bStepTimer = setInterval(() => {
      step++;
      showD2BSteps(steps, step);
      if (step >= steps.length) {
        clearInterval(d2bStepTimer);
        d2bStepTimer = null;
        document.getElementById('d2b-result').textContent = binStr + '  (' + dec + '₁₀)';
        makeBitsRow(document.getElementById('d2b-bits'), binStr);
      }
    }, 600);
  }
}

function showD2BSteps(steps, count) {
  let html = '';
  for (let i = 0; i < steps.length; i++) {
    const s = steps[i];
    const visible = i < count;
    const style = visible ? '' : 'opacity:0.15';
    const highlight = (i === count - 1 && count > 0) ? 'font-weight:bold;color:#e6edf3' : '';
    html += `<div style="${style};${highlight}">`;
    html += `<span class="quo">${s.val}</span> ÷ 2 = <span class="quo">${s.q}</span> remainder <span class="rem">${s.r}</span>`;
    html += `</div>`;
  }
  if (count >= steps.length && steps.length > 0) {
    html += `<div style="margin-top:6px"><span class="arrow">↑ Read remainders bottom→top: </span>`;
    html += `<span class="rem" style="font-size:1.2em;letter-spacing:2px">${steps.map(s => s.r).reverse().join('')}</span></div>`;
  }
  document.getElementById('d2b-steps').innerHTML = html;
}

document.getElementById('d2b-go').onclick = () => d2bConvert(false);
document.getElementById('d2b-step').onclick = () => d2bConvert(true);
document.getElementById('d2b-random').onclick = () => {
  document.getElementById('d2b-input').value = Math.floor(Math.random() * 256);
  d2bConvert(false);
};
document.getElementById('d2b-input').addEventListener('keydown', e => { if (e.key === 'Enter') d2bConvert(false); });

// ══════════════════════════════════════
//  TAB 2: Binary → Decimal
// ══════════════════════════════════════
function b2dConvert() {
  let binStr = document.getElementById('b2d-input').value.replace(/[^01]/g, '');
  if (binStr.length === 0) binStr = '0';
  if (binStr.length > 8) binStr = binStr.slice(-8);
  document.getElementById('b2d-input').value = binStr;

  const len = binStr.length;
  const bits = binStr.split('');
  let dec = 0;
  const terms = [];

  for (let i = 0; i < len; i++) {
    const power = len - 1 - i;
    const weight = 1 << power;
    const bit = +bits[i];
    const contribution = bit * weight;
    dec += contribution;
    if (bit === 1) {
      terms.push({ bit, power, weight, contribution });
    }
  }

  document.getElementById('b2d-result').textContent = dec + '  (0b' + binStr + ')';

  // Interactive bits
  const area = document.getElementById('b2d-bits-area');
  area.innerHTML = '<div class="bits-row" id="b2d-bits"></div>';
  makeBitsRow(document.getElementById('b2d-bits'), binStr.padStart(8, '0'), {
    clickable: true,
    onToggle: (newBin) => {
      document.getElementById('b2d-input').value = newBin.replace(/^0+/, '') || '0';
      b2dConvert();
    }
  });

  // Step breakdown
  let html = '';
  const allTerms = [];
  for (let i = 0; i < len; i++) {
    const power = len - 1 - i;
    const weight = 1 << power;
    const bit = +bits[i];
    const color = bit === 1 ? '#3fb950' : '#484f58';
    allTerms.push(`<span style="color:${color}">${bit}×${weight}</span>`);
  }
  html += allTerms.join(' + ');
  html += `<br>= `;
  if (terms.length > 0) {
    html += terms.map(t => `<span style="color:#3fb950">${t.contribution}</span>`).join(' + ');
    html += ` = <span style="color:#f78166;font-size:1.2em;font-weight:bold">${dec}</span>`;
  } else {
    html += `<span style="color:#f78166;font-size:1.2em;font-weight:bold">0</span>`;
  }
  document.getElementById('b2d-steps').innerHTML = html;
}

document.getElementById('b2d-go').onclick = b2dConvert;
document.getElementById('b2d-random').onclick = () => {
  const n = Math.floor(Math.random() * 256);
  document.getElementById('b2d-input').value = n.toString(2);
  b2dConvert();
};
document.getElementById('b2d-input').addEventListener('keydown', e => { if (e.key === 'Enter') b2dConvert(); });

// ══════════════════════════════════════
//  TAB 3: Binary Addition
// ══════════════════════════════════════
let addStepTimer = null;

function addCompute(stepping) {
  if (addStepTimer) { clearInterval(addStepTimer); addStepTimer = null; }
  let a = Math.max(0, Math.min(127, Math.floor(+document.getElementById('add-a').value) || 0));
  let b = Math.max(0, Math.min(127, Math.floor(+document.getElementById('add-b').value) || 0));
  document.getElementById('add-a').value = a;
  document.getElementById('add-b').value = b;

  const sum = a + b;
  const bits = Math.max(8, Math.ceil(Math.log2(Math.max(sum, 1) + 1)));
  const aBin = toBin(a, bits);
  const bBin = toBin(b, bits);
  const sBin = toBin(sum, bits + 1); // extra bit for overflow

  // Compute carries and per-column results
  const carries = new Array(bits + 1).fill(0);
  const results = new Array(bits).fill(0);
  let carry = 0;
  for (let i = bits - 1; i >= 0; i--) {
    const ab = +aBin[i];
    const bb = +bBin[i];
    const s = ab + bb + carry;
    results[i] = s % 2;
    carries[i] = Math.floor(s / 2); // carry OUT from this column = carry IN to next
    carry = carries[i];
  }
  const finalCarry = carry;

  if (!stepping) {
    showAddSteps(aBin, bBin, carries, results, finalCarry, bits, bits);
    document.getElementById('add-result').innerHTML =
      `<span style="color:#f78166">${a}</span> + <span style="color:#f78166">${b}</span> = <span style="color:#3fb950">${sum}</span>` +
      `<br><span style="font-size:.7em;color:#8b949e">${aBin} + ${bBin} = ${toBin(sum, bits + (finalCarry ? 1 : 0))}</span>`;
  } else {
    document.getElementById('add-result').textContent = '...';
    let step = 0;
    showAddSteps(aBin, bBin, carries, results, finalCarry, bits, -1);
    addStepTimer = setInterval(() => {
      showAddSteps(aBin, bBin, carries, results, finalCarry, bits, step);
      step++;
      if (step > bits) {
        clearInterval(addStepTimer);
        addStepTimer = null;
        document.getElementById('add-result').innerHTML =
          `<span style="color:#f78166">${a}</span> + <span style="color:#f78166">${b}</span> = <span style="color:#3fb950">${sum}</span>` +
          `<br><span style="font-size:.7em;color:#8b949e">${aBin} + ${bBin} = ${toBin(sum, bits + (finalCarry ? 1 : 0))}</span>`;
      }
    }, 500);
  }
}

function showAddSteps(aBin, bBin, carries, results, finalCarry, bits, revealCol) {
  // revealCol: index from right (0=LSB). -1 = nothing revealed yet. bits = all revealed.
  const box = document.getElementById('add-steps');
  let html = '';

  // Carry row
  html += '<div class="step-row carry-row">';
  html += '<div class="step-label" style="color:#d29922">Carry</div>';
  if (finalCarry && revealCol >= bits) {
    html += `<div class="step-cell" style="color:#d29922">1</div>`;
  } else {
    html += `<div class="step-cell"></div>`;
  }
  for (let i = 0; i < bits; i++) {
    const col = bits - 1 - i; // column from right
    const show = col < revealCol && carries[i] > 0;
    html += `<div class="step-cell">${show ? carries[i] : ''}</div>`;
  }
  html += '</div>';

  // A row
  html += '<div class="step-row">';
  html += '<div class="step-label">A</div>';
  html += '<div class="step-cell"></div>';
  for (let i = 0; i < bits; i++) {
    const col = bits - 1 - i;
    const active = col === revealCol ? 'background:#1f6feb30;border-radius:4px' : '';
    html += `<div class="step-cell" style="color:#58a6ff;${active}">${aBin[i]}</div>`;
  }
  html += '</div>';

  // B row (with + sign)
  html += '<div class="step-row">';
  html += '<div class="step-label" style="color:#bc8cff">+ B</div>';
  html += '<div class="step-cell"></div>';
  for (let i = 0; i < bits; i++) {
    const col = bits - 1 - i;
    const active = col === revealCol ? 'background:#bc8cff20;border-radius:4px' : '';
    html += `<div class="step-cell" style="color:#bc8cff;${active}">${bBin[i]}</div>`;
  }
  html += '</div>';

  // Separator
  html += '<div class="step-row"><div class="step-label"></div>';
  for (let i = 0; i <= bits; i++) html += '<div class="step-cell" style="border-bottom:2px solid #30363d;height:4px"></div>';
  html += '</div>';

  // Result row
  html += '<div class="step-row result-row">';
  html += '<div class="step-label" style="color:#3fb950">Sum</div>';
  // Overflow bit
  if (finalCarry && revealCol >= bits) {
    html += `<div class="step-cell" style="color:#3fb950">1</div>`;
  } else {
    html += `<div class="step-cell"></div>`;
  }
  for (let i = 0; i < bits; i++) {
    const col = bits - 1 - i;
    const show = col <= revealCol;
    const fresh = col === revealCol;
    html += `<div class="step-cell" style="color:#3fb950;${fresh ? 'background:#3fb95020;border-radius:4px' : ''}">${show ? results[i] : ''}</div>`;
  }
  html += '</div>';

  // Column explanation
  if (revealCol >= 0 && revealCol < bits) {
    const i = bits - 1 - revealCol;
    const ab = +aBin[i], bb = +bBin[i];
    const cin = (revealCol + 1 < bits) ? carries[i + 1] || 0 : 0;
    // Actually, carries[i] is carry OUT from column i. carry IN to column i is carries[i+1] or the previous carry.
    // Let me recalculate: for column index i (from left), the carry IN comes from i+1 (which is the column to the right)
    // Wait, carries[i] = carry OUT from column i. carry IN to column i is carries[i] from the NEXT column (i+1)?
    // No: we computed left-to-right but the addition goes right-to-left. Let me reconsider.
    // Actually in the compute loop above: for i from bits-1 down to 0, carries[i] = carry OUT.
    // carry IN to column i is carries[i+1] if i < bits-1, else 0 for the rightmost column.
    const carryIn = (i < bits - 1) ? carries[i + 1] : 0;
    const total = ab + bb + carryIn;
    const rBit = total % 2;
    const cOut = Math.floor(total / 2);
    html += `<div style="text-align:center;font-size:.82em;color:#8b949e;margin-top:6px">`;
    html += `Column 2${superscript(revealCol)}: `;
    html += `<span style="color:#58a6ff">${ab}</span> + <span style="color:#bc8cff">${bb}</span>`;
    if (carryIn) html += ` + <span style="color:#d29922">carry ${carryIn}</span>`;
    html += ` = ${total} → write <span style="color:#3fb950;font-weight:bold">${rBit}</span>`;
    if (cOut) html += `, carry <span style="color:#d29922;font-weight:bold">${cOut}</span>`;
    html += `</div>`;
  }

  box.innerHTML = html;
}

document.getElementById('add-go').onclick = () => addCompute(false);
document.getElementById('add-step').onclick = () => addCompute(true);
document.getElementById('add-random').onclick = () => {
  document.getElementById('add-a').value = Math.floor(Math.random() * 128);
  document.getElementById('add-b').value = Math.floor(Math.random() * 128);
  addCompute(false);
};

// ══════════════════════════════════════
//  TAB 4: Binary Subtraction
// ══════════════════════════════════════
let subStepTimer = null;

function subCompute(stepping) {
  if (subStepTimer) { clearInterval(subStepTimer); subStepTimer = null; }
  let a = Math.max(0, Math.min(255, Math.floor(+document.getElementById('sub-a').value) || 0));
  let b = Math.max(0, Math.min(255, Math.floor(+document.getElementById('sub-b').value) || 0));
  document.getElementById('sub-a').value = a;
  document.getElementById('sub-b').value = b;

  const method = document.getElementById('sub-method').value;

  if (method === 'borrow') {
    subBorrow(a, b, stepping);
  } else if (method === 'ones') {
    subOnes(a, b, stepping);
  } else {
    subTwos(a, b, stepping);
  }
}

function subBorrow(a, b, stepping) {
  const diff = a - b;
  const negative = diff < 0;
  const absDiff = Math.abs(diff);
  // If negative, compute |a-b| = b-a and note the sign
  const bigVal = negative ? b : a;
  const smallVal = negative ? a : b;

  const bits = 8;
  const bigBin = toBin(bigVal, bits);
  const smallBin = toBin(smallVal, bits);
  const diffBin = toBin(absDiff, bits);

  // Column-by-column subtraction with borrow
  const borrows = new Array(bits).fill(0);
  const results = new Array(bits).fill(0);
  const bigDigits = bigBin.split('').map(Number);
  const smallDigits = smallBin.split('').map(Number);

  for (let i = bits - 1; i >= 0; i--) {
    let top = bigDigits[i] - borrows[i];
    if (top < smallDigits[i]) {
      top += 2; // borrow
      if (i > 0) borrows[i - 1] = 1;
    }
    results[i] = top - smallDigits[i];
  }

  if (!stepping) {
    showSubBorrowSteps(bigBin, smallBin, borrows, results, bits, bits, negative, a, b, diff);
  } else {
    document.getElementById('sub-result').textContent = '...';
    let step = 0;
    showSubBorrowSteps(bigBin, smallBin, borrows, results, bits, -1, negative, a, b, diff);
    subStepTimer = setInterval(() => {
      showSubBorrowSteps(bigBin, smallBin, borrows, results, bits, step, negative, a, b, diff);
      step++;
      if (step > bits) {
        clearInterval(subStepTimer);
        subStepTimer = null;
        document.getElementById('sub-result').innerHTML =
          `<span style="color:#f78166">${a}</span> − <span style="color:#f78166">${b}</span> = <span style="color:#3fb950">${diff}</span>` +
          `<br><span style="font-size:.7em;color:#8b949e">${negative ? '−(' : ''}${bigBin} − ${smallBin}${negative ? ')' : ''} = ${negative ? '−' : ''}${diffBin}</span>`;
      }
    }, 500);
  }
}

function showSubBorrowSteps(topBin, botBin, borrows, results, bits, revealCol, negative, a, b, diff) {
  const box = document.getElementById('sub-steps');
  let html = '';

  if (negative) {
    html += `<div style="text-align:center;font-size:.82em;color:#da3633;margin-bottom:8px">Since ${a} < ${b}, computing ${b} − ${a} and negating the result.</div>`;
  }

  // Borrow row
  html += '<div class="step-row borrow-row">';
  html += '<div class="step-label" style="color:#da3633">Borrow</div>';
  for (let i = 0; i < bits; i++) {
    const col = bits - 1 - i;
    const show = col < revealCol && borrows[i] > 0;
    html += `<div class="step-cell">${show ? borrows[i] : ''}</div>`;
  }
  html += '</div>';

  // Top row (minuend)
  html += '<div class="step-row">';
  html += '<div class="step-label">A</div>';
  for (let i = 0; i < bits; i++) {
    const col = bits - 1 - i;
    const active = col === revealCol ? 'background:#58a6ff20;border-radius:4px' : '';
    html += `<div class="step-cell" style="color:#58a6ff;${active}">${topBin[i]}</div>`;
  }
  html += '</div>';

  // Bottom row (subtrahend)
  html += '<div class="step-row">';
  html += '<div class="step-label" style="color:#da3633">− B</div>';
  for (let i = 0; i < bits; i++) {
    const col = bits - 1 - i;
    const active = col === revealCol ? 'background:#da363320;border-radius:4px' : '';
    html += `<div class="step-cell" style="color:#da3633;${active}">${botBin[i]}</div>`;
  }
  html += '</div>';

  // Separator
  html += '<div class="step-row"><div class="step-label"></div>';
  for (let i = 0; i < bits; i++) html += '<div class="step-cell" style="border-bottom:2px solid #30363d;height:4px"></div>';
  html += '</div>';

  // Result
  html += '<div class="step-row result-row">';
  html += '<div class="step-label" style="color:#3fb950">Diff</div>';
  for (let i = 0; i < bits; i++) {
    const col = bits - 1 - i;
    const show = col <= revealCol;
    const fresh = col === revealCol;
    html += `<div class="step-cell" style="color:#3fb950;${fresh ? 'background:#3fb95020;border-radius:4px' : ''}">${show ? results[i] : ''}</div>`;
  }
  html += '</div>';

  // Column explanation
  if (revealCol >= 0 && revealCol < bits) {
    const i = bits - 1 - revealCol;
    const t = +topBin[i] - borrows[i];
    const bt = +botBin[i];
    const borrowed = t < bt;
    html += `<div style="text-align:center;font-size:.82em;color:#8b949e;margin-top:6px">`;
    html += `Column 2${superscript(revealCol)}: `;
    html += `<span style="color:#58a6ff">${topBin[i]}</span>`;
    if (borrows[i]) html += ` − <span style="color:#da3633">borrow 1</span> = ${t}`;
    html += ` − <span style="color:#da3633">${bt}</span>`;
    if (borrowed) html += ` → need to borrow (${t}+2−${bt} = <span style="color:#3fb950;font-weight:bold">${t + 2 - bt}</span>)`;
    else html += ` = <span style="color:#3fb950;font-weight:bold">${t - bt}</span>`;
    html += `</div>`;
  }

  if (revealCol >= bits) {
    document.getElementById('sub-result').innerHTML =
      `<span style="color:#f78166">${a}</span> − <span style="color:#f78166">${b}</span> = <span style="color:#3fb950">${diff}</span>` +
      `<br><span style="font-size:.7em;color:#8b949e">${negative ? '−' : ''}${results.join('')} = ${diff}</span>`;
  }

  box.innerHTML = html;
}

function subOnes(a, b, stepping) {
  const bits = 9; // 8 data bits + sign
  const aBin = toBin(a, bits);
  const bBin = toBin(b, bits);
  const result = a - b;

  // One's complement of B: invert all bits (no +1, unlike two's complement)
  const bInv = bBin.split('').map(c => c === '0' ? '1' : '0').join('');
  const bInvVal = parseInt(bInv, 2);

  // Step 1: Add A + ~B
  const rawSum1 = a + bInvVal;
  const sum1Bits = toBin(rawSum1, bits + 1);
  const hasCarry = sum1Bits[0] === '1';
  const partial = sum1Bits.slice(1); // discard overflow bit
  const partialVal = parseInt(partial, 2);

  // Step 2: End-around carry — if there's an overflow carry, add it back to the result
  // If no carry, result is negative; take one's complement of partial to get magnitude
  let finalVal, finalBin;
  if (hasCarry) {
    finalVal = partialVal + 1; // add the carry back
    finalBin = toBin(finalVal, bits);
  } else {
    // Negative result: partial is in one's complement form
    // Invert to get magnitude
    const mag = partial.split('').map(c => c === '0' ? '1' : '0').join('');
    finalVal = parseInt(mag, 2);
    finalBin = mag;
  }

  const box = document.getElementById('sub-steps');
  let html = '';

  html += `<div style="text-align:center;font-size:.85em;color:#8b949e;margin-bottom:8px">`;
  html += `A − B = A + (one's complement of B), then <strong style="color:#d29922">end-around carry</strong></div>`;

  // Show B
  html += `<div style="text-align:center;margin:6px 0"><span style="color:#8b949e">B = </span><span style="font-family:'Courier New',monospace;color:#bc8cff">${bBin}</span>`;
  html += `<span style="color:#8b949e;font-size:.85em"> (${b})</span></div>`;

  // Show ~B (one's complement)
  html += `<div style="text-align:center;margin:6px 0"><span style="color:#8b949e">~B = </span><span style="font-family:'Courier New',monospace;color:#d29922">${bInv}</span>`;
  html += `<span style="color:#8b949e;font-size:.85em"> (invert all bits — one's complement of ${b})</span></div>`;

  // Step 1: A + ~B
  html += `<div style="text-align:center;font-size:.85em;color:#58a6ff;margin:10px 0"><strong>Step 1:</strong> Add A + ~B</div>`;
  html += '<div style="margin:8px 0">';

  // A row
  html += '<div class="step-row">';
  html += '<div class="step-label">A</div>';
  html += '<div class="step-cell"></div>';
  for (let i = 0; i < bits; i++) {
    html += `<div class="step-cell" style="color:#58a6ff">${aBin[i]}</div>`;
  }
  html += '</div>';

  // ~B row
  html += '<div class="step-row">';
  html += '<div class="step-label" style="color:#d29922">+ ~B</div>';
  html += '<div class="step-cell"></div>';
  for (let i = 0; i < bits; i++) {
    html += `<div class="step-cell" style="color:#d29922">${bInv[i]}</div>`;
  }
  html += '</div>';

  // Separator
  html += '<div class="step-row"><div class="step-label"></div>';
  for (let i = 0; i <= bits; i++) html += '<div class="step-cell" style="border-bottom:2px solid #30363d;height:4px"></div>';
  html += '</div>';

  // Raw sum (with overflow bit)
  html += '<div class="step-row">';
  html += '<div class="step-label" style="color:#8b949e">Sum</div>';
  const oColor = hasCarry ? '#d29922' : '#484f58';
  html += `<div class="step-cell" style="color:${oColor};font-size:.9em">${sum1Bits[0]}</div>`;
  for (let i = 1; i <= bits; i++) {
    html += `<div class="step-cell" style="color:#e6edf3">${sum1Bits[i]}</div>`;
  }
  html += '</div>';
  html += '</div>';

  // Step 2: End-around carry
  if (hasCarry) {
    html += `<div style="text-align:center;font-size:.85em;color:#d29922;margin:10px 0">`;
    html += `<strong>Step 2:</strong> Carry out = <strong>1</strong> → add it back to the result (end-around carry)</div>`;

    html += '<div style="margin:8px 0">';
    html += '<div class="step-row">';
    html += '<div class="step-label" style="color:#8b949e">Partial</div>';
    for (let i = 0; i < bits; i++) {
      html += `<div class="step-cell" style="color:#e6edf3">${partial[i]}</div>`;
    }
    html += '</div>';

    html += '<div class="step-row">';
    html += '<div class="step-label" style="color:#d29922">+ carry</div>';
    for (let i = 0; i < bits - 1; i++) {
      html += '<div class="step-cell"></div>';
    }
    html += '<div class="step-cell" style="color:#d29922">1</div>';
    html += '</div>';

    // Separator
    html += '<div class="step-row"><div class="step-label"></div>';
    for (let i = 0; i < bits; i++) html += '<div class="step-cell" style="border-bottom:2px solid #30363d;height:4px"></div>';
    html += '</div>';

    // Final result
    html += '<div class="step-row result-row">';
    html += '<div class="step-label" style="color:#3fb950">Result</div>';
    for (let i = 0; i < bits; i++) {
      html += `<div class="step-cell" style="color:#3fb950">${finalBin[i]}</div>`;
    }
    html += '</div>';
    html += '</div>';

    html += `<div style="text-align:center;font-size:.85em;color:#3fb950;margin-top:8px">`;
    html += `Result = <strong>+${finalVal}</strong> = <strong>${result}</strong></div>`;
  } else {
    html += `<div style="text-align:center;font-size:.85em;color:#da3633;margin:10px 0">`;
    html += `<strong>Step 2:</strong> No carry out → result is <strong>negative</strong>. Invert the sum to get the magnitude.</div>`;

    html += '<div style="margin:8px 0">';
    html += '<div class="step-row">';
    html += '<div class="step-label" style="color:#8b949e">Sum</div>';
    for (let i = 0; i < bits; i++) {
      html += `<div class="step-cell" style="color:#e6edf3">${partial[i]}</div>`;
    }
    html += '</div>';

    html += '<div class="step-row">';
    html += '<div class="step-label" style="color:#da3633">~Sum</div>';
    for (let i = 0; i < bits; i++) {
      html += `<div class="step-cell" style="color:#da3633">${finalBin[i]}</div>`;
    }
    html += '</div>';
    html += '</div>';

    html += `<div style="text-align:center;font-size:.85em;color:#da3633;margin-top:8px">`;
    html += `Magnitude = ${finalVal}, so result = <strong>−${finalVal}</strong> = <strong>${result}</strong></div>`;
  }

  box.innerHTML = html;
  document.getElementById('sub-result').innerHTML =
    `<span style="color:#f78166">${a}</span> − <span style="color:#f78166">${b}</span> = <span style="color:#3fb950">${result}</span>` +
    `<br><span style="font-size:.7em;color:#8b949e">One's complement method</span>`;
}

function subTwos(a, b, stepping) {
  const bits = 9; // 8 data bits + sign
  const aBin = toBin(a, bits);
  const bBin = toBin(b, bits);
  // Two's complement of B: invert all bits, add 1
  const bInv = bBin.split('').map(c => c === '0' ? '1' : '0').join('');
  const bTwos = toBin((~b & ((1 << bits) - 1)) + 1, bits); // proper two's complement
  // Add A + two's complement of B
  const rawSum = a + ((~b & ((1 << bits) - 1)) + 1);
  const sumBits = toBin(rawSum, bits + 1);
  const result = a - b;

  const box = document.getElementById('sub-steps');
  let html = '';

  html += `<div style="text-align:center;font-size:.85em;color:#8b949e;margin-bottom:8px">`;
  html += `A − B = A + (two's complement of B) = A + (~B + 1)</div>`;

  // Show B
  html += `<div style="text-align:center;margin:6px 0"><span style="color:#8b949e">B = </span><span style="font-family:'Courier New',monospace;color:#bc8cff">${bBin}</span>`;
  html += `<span style="color:#8b949e;font-size:.85em"> (${b})</span></div>`;

  // Show ~B
  html += `<div style="text-align:center;margin:6px 0"><span style="color:#8b949e">~B = </span><span style="font-family:'Courier New',monospace;color:#d29922">${bInv}</span>`;
  html += `<span style="color:#8b949e;font-size:.85em"> (invert all bits)</span></div>`;

  // Show ~B + 1
  html += `<div style="text-align:center;margin:6px 0"><span style="color:#8b949e">~B + 1 = </span><span style="font-family:'Courier New',monospace;color:#da3633">${bTwos}</span>`;
  html += `<span style="color:#8b949e;font-size:.85em"> (two's complement of ${b})</span></div>`;

  // Show addition
  html += `<div style="margin:12px 0">`;
  // A row
  html += '<div class="step-row">';
  html += '<div class="step-label">A</div>';
  for (let i = 0; i < bits; i++) {
    html += `<div class="step-cell" style="color:#58a6ff">${aBin[i]}</div>`;
  }
  html += '</div>';

  // -B (two's complement) row
  html += '<div class="step-row">';
  html += '<div class="step-label" style="color:#da3633">+ (−B)</div>';
  for (let i = 0; i < bits; i++) {
    html += `<div class="step-cell" style="color:#da3633">${bTwos[i]}</div>`;
  }
  html += '</div>';

  // Separator
  html += '<div class="step-row"><div class="step-label"></div>';
  for (let i = 0; i < bits; i++) html += '<div class="step-cell" style="border-bottom:2px solid #30363d;height:4px"></div>';
  html += '</div>';

  // Raw result
  html += '<div class="step-row">';
  html += '<div class="step-label" style="color:#3fb950">Raw</div>';
  // Show the overflow bit separately
  const overflowBit = sumBits[0];
  for (let i = 1; i <= bits; i++) {
    html += `<div class="step-cell" style="color:#3fb950">${sumBits[i]}</div>`;
  }
  html += '</div>';
  html += '</div>';

  // Interpretation
  if (result >= 0) {
    html += `<div style="text-align:center;font-size:.85em;color:#3fb950;margin-top:8px">`;
    html += `Overflow carry = ${overflowBit} (discard). Result = <strong>${result}</strong> (${toBin(result, bits)})</div>`;
  } else {
    const resBin = sumBits.slice(1);
    html += `<div style="text-align:center;font-size:.85em;color:#da3633;margin-top:8px">`;
    html += `MSB = 1 → negative. Take two's complement of result to get magnitude: <strong>${Math.abs(result)}</strong>. Answer = <strong>${result}</strong></div>`;
  }

  box.innerHTML = html;
  document.getElementById('sub-result').innerHTML =
    `<span style="color:#f78166">${a}</span> − <span style="color:#f78166">${b}</span> = <span style="color:#3fb950">${result}</span>` +
    `<br><span style="font-size:.7em;color:#8b949e">Two's complement method</span>`;
}

document.getElementById('sub-go').onclick = () => subCompute(false);
document.getElementById('sub-step').onclick = () => subCompute(true);
document.getElementById('sub-random').onclick = () => {
  const a = Math.floor(Math.random() * 200);
  const b = Math.floor(Math.random() * 200);
  document.getElementById('sub-a').value = Math.max(a, b);
  document.getElementById('sub-b').value = Math.min(a, b);
  subCompute(false);
};

// Initial renders
d2bConvert(false);
</script>
</body>
</html>
